---
- name: Instalacion de moodle
  hosts: frontend
  become: yes

  tasks:
    - name: Ensure required packages are installed
      apt:
        name:
          - apache2
          - unzip
          - wget
        state: present

    - name: Enable Apache rewrite module
      command: a2enmod rewrite
      notify: Restart Apache

    - name: Remove previous Moodle installation
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /tmp/v4.3.1.zip
        - /var/www/html/*

    - name: Download Moodle source code
      get_url:
        url: https://github.com/moodle/moodle/archive/refs/tags/v4.3.1.zip
        dest: /tmp/v4.3.1.zip

    - name: Extract Moodle archive
      unarchive:
        src: /tmp/v4.3.1.zip
        dest: /tmp
        remote_src: yes

    - name: Move Moodle files to /var/www/html
      command: mv /tmp/moodle-4.3.1/* /var/www/html/

    - name: Set correct ownership and permissions for Moodle
      file:
        path: /var/www/html
        owner: www-data
        group: www-data
        mode: "0755"
        recurse: yes

    - name: Create Moodle data directory
      file:
        path: /var/moodledata
        state: directory
        owner: www-data
        group: www-data
        mode: "0777"

    - name: Update PHP configuration
      replace:
        path: "{{ item }}"
        regexp: ";max_input_vars = 1000"
        replace: "max_input_vars = 5000"
      loop:
        - /etc/php/8.3/apache2/php.ini
        - /etc/php/8.3/cli/php.ini
      notify: Restart Apache

    - name: Install Moodle
      command: >
        sudo -u www-data php /var/www/html/admin/cli/install.php
        --lang={{ MOODLE_LANG }}
        --wwwroot={{ MOODLE_WWWROOT }}
        --dataroot={{ MOODLE_DATAROOT }}
        --dbtype={{ MOODLE_DB_TYPE }}
        --dbhost={{ BACKEND_PRIVATE_IP }}
        --dbname={{ MOODLE_DB_NAME }}
        --dbuser={{ MOODLE_DB_USER }}
        --dbpass={{ MOODLE_DB_PASS }}
        --fullname="{{ MOODLE_FULLNAME }}"
        --shortname="{{ MOODLE_SHORTNAME }}"
        --summary="{{ MOODLE_SUMMARY }}"
        --adminuser={{ MOODLE_ADMIN_USER }}
        --adminpass={{ MOODLE_ADMIN_PASS }}
        --adminemail={{ MOODLE_ADMIN_EMAIL }}
        --non-interactive
        --agree-license

    - name: Configure Moodle settings
      lineinfile:
        path: /var/www/html/config.php
        insertafter: "$CFG->admin"
        line: |
          $CFG->reverseproxy=1;
          $CFG->sslproxy=1;
      notify: Restart Apache

  handlers:
    - name: Restart Apache
      service:
        name: apache2
        state: reloaded
